---

name: "Build nrf-docker image"

on:
  # workflow_dispatch:
  push:
    paths:
     - '.devcontainer/nrf-docker/**'
     - '.github/workflows/docker-build-nrf-docker.yml'
 
env:
  ARTIFACTS_DIR: ~/artifacts/nrf-docker

jobs:

  build-nrf-docker-image:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Create artifact directory
        run: |
          mkdir -p $ARTIFACTS_DIR
          # create file with timestamp as the name
          touch $ARTIFACTS_DIR/$(date +%s).txt
          ls -la $ARTIFACTS_DIR

      - name: Build the nrf-docker image and save it as a tarball
        run: |
          echo "woefneofne" > "${ARTIFACTS_DIR}/nrf-docker.tar"
          # docker build \
          # --file .devcontainer/nrf-docker/Dockerfile \
          # --tag ghcr.io/tigitlabs/nrf-docker \
          # --output type=tar,dest=${ARTIFACTS_DIR}/nrf-docker.tar \
          # .devcontainer/nrf-docker/

      - name: Save artifact
        uses: actions/upload-artifact@v3
        with:
          name: nrf-docker
          path: ${{ env.ARTIFACTS_DIR }}/nrf-docker.tar
          if-no-files-found: error

      - name: check artifact size
        run: |
          du -sh $ARTIFACTS_DIR/nrf-docker.tar
          echo "ls -la"
          ls -la $ARTIFACTS_DIR/
          echo "ls /home/runner/artifacts/nrf-docker/"
          cd $ARTIFACTS_DIR/
          pwd
          ls -la /home/runner/artifacts/nrf-docker/

  run-container-tests:
    runs-on: ubuntu-latest
    needs: build-nrf-docker-image
    steps:
      - uses: actions/checkout@v3
      - name: Load the nrf-docker artifact
        uses: actions/download-artifact@v3
        with:
          name: nrf-docker

      - name: check artifact size
        run: |
          echo "ls -la"
          ls -la
          echo "pwd"
          echo "cat the tar"
          cat nrf-docker.tar
          pwd

      - name: Load the nrf-docker image
        run: docker load --input nrf-docker.tar

      - name: Run the nrf-docker container
        run: docker run --rm nrf-docker west --version
