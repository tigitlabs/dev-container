---

name: "Docker-Build-Publish"

on:
  workflow_run:
    workflows: ["Makefile-CI"]
    types: [ completed ]
  workflow_dispatch:

env:
  NRF_USER: vscode

jobs:

  build-and-push-ubuntu-base:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v2

      - name: Build the Ubuntu base image
        run: |
          docker build \
          --file .devcontainer/ubuntu-base/Dockerfile \
          --tag ghcr.io/tigitlabs/ubuntu-base:latest \
          --tag ghcr.io/tigitlabs/ubuntu-base:dev \
          .devcontainer/ubuntu-base/

      - name: Login to GitHub Container Registry
        if: ${{ !env.ACT }}
        uses: docker/login-action@v1
        with:
          registry: ghcr.io
          username: ${{github.actor}}
          password: ${{secrets.GITHUB_TOKEN}}

      - name: Publish image
        if: ${{ !env.ACT }}
        run: |
          docker push ghcr.io/tigitlabs/ubuntu-base --all-tags

  build-and-push-nrf-docker-image:
    needs: [ build-and-push-ubuntu-base ]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v2
      - name: Build the nrf-docker image
        run: |
          docker build \
          --file .devcontainer/nrf-docker/Dockerfile \
          --tag ghcr.io/tigitlabs/nrf-docker:latest \
          --tag ghcr.io/tigitlabs/nrf-docker:dev \
          .devcontainer/nrf-docker/

      - name: Ensure clang-format works
        run: |
          docker run \
          --rm \
          --user $NRF_USER \
          ghcr.io/tigitlabs/nrf-docker:latest \
          clang-format --version

      - name: Ensure west works
        run: |
          docker run \
          --rm \
          --user $NRF_USER \
          ghcr.io/tigitlabs/nrf-docker:latest \
          west --version

      - name: Ensure nrfutil installation works
        run: |
          docker run \
          --rm \
          --user $NRF_USER \
          ghcr.io/tigitlabs/nrf-docker:latest \
          nrfutil toolchain-manager list

      - name: Login to GitHub Container Registry
        if: ${{ !env.ACT }}
        uses: docker/login-action@v1
        with:
          registry: ghcr.io
          username: ${{github.actor}}
          password: ${{secrets.GITHUB_TOKEN}}

      - name: Publish image
        if: ${{ !env.ACT }}
        run: |
          docker push ghcr.io/tigitlabs/nrf-docker  --all-tags

  build-and-push-nrf-docker-ci-image:
    needs: [ build-and-push-nrf-docker-image ]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v2
      - name: Build the nrf-docker image
        run: |
          docker build \
          --file .devcontainer/nrf-docker/ci.Dockerfile \
          --tag ghcr.io/tigitlabs/nrf-docker-ci:latest \
          --tag ghcr.io/tigitlabs/nrf-docker-ci:dev \
          .devcontainer/nrf-docker/

      - name: Ensure clang-format works
        run: |
          docker run \
          --rm \
          --user $NRF_USER \
          ghcr.io/tigitlabs/nrf-docker:latest \
          clang-format --version

      - name: Ensure west works
        run: |
          docker run \
          --rm \
          --user $NRF_USER \
          ghcr.io/tigitlabs/nrf-docker:latest \
          west --version

      - name: Ensure nrfutil installation works
        run: |
          docker run \
          --rm \
          --user $NRF_USER \
          ghcr.io/tigitlabs/nrf-docker:latest \
          nrfutil toolchain-manager list

      - name: Build asset_tracker_v2 application
        run: | 
          docker run \
          --rm \
          --user $NRF_USER \
          --workdir /workspace/nrf/applications/asset_tracker_v2 \
          ghcr.io/tigitlabs/nrf-docker \
          west build -b nrf9160dk_nrf9160ns --build-dir /workspace/nrf/applications/asset_tracker_v2/build -- -DEXTRA_CFLAGS="-Werror -Wno-dev"

      - name: Login to GitHub Container Registry
        if: ${{ !env.ACT }}
        uses: docker/login-action@v1
        with:
          registry: ghcr.io
          username: ${{github.actor}}
          password: ${{secrets.GITHUB_TOKEN}}

      - name: Publish image
        if: ${{ !env.ACT }}
        run: |
          docker push ghcr.io/tigitlabs/nrf-docker-ci --all-tags

      - name: Login to GitHub Container Registry
        if: ${{ !env.ACT }}
        uses: docker/login-action@v1
        with:
          registry: ghcr.io
          username: ${{github.actor}}
          password: ${{secrets.GITHUB_TOKEN}}

      - name: Publish image
        if: ${{ !env.ACT }}
        run: |
          docker push ghcr.io/tigitlabs/nrf-docker-ci --all-tags

  build-and-push-nrf-codespace-image:
    needs: [ build-and-push-nrf-docker-image ]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v2
      - name: Build the nrf-codespace image
        run: |
          docker build \
          --file .devcontainer/nrf-codespace/Dockerfile \
          --tag ghcr.io/tigitlabs/nrf-codespace:latest \
          --tag ghcr.io/tigitlabs/nrf-codespace:dev \
          .devcontainer/nrf-codespace/

      - name: Ensure nrfjprog works
        run: |
          docker run \
          --rm \
          --user $NRF_USER \
          ghcr.io/tigitlabs/nrf-codespace:latest \
          nrfjprog -v

      - name: Login to GitHub Container Registry
        if: ${{ !env.ACT }}
        uses: docker/login-action@v1
        with:
          registry: ghcr.io
          username: ${{github.actor}}
          password: ${{secrets.GITHUB_TOKEN}}

      - name: Publish image
        if: ${{ !env.ACT }}
        run: |
          docker push ghcr.io/tigitlabs/nrf-codespace --all-tags
